/*!
 * Myna for HTML v1.1.3 (no dependencies)
 * Copyright 2012 Myna Ltd
 * License: BSD 3-clause (http://opensource.org/licenses/BSD-3-Clause)
 * Published: 2013-01-25
 * Dependencies:
 *  - jQuery 1.5+ http://jquery.com/download
 *  - JSON.{parse,stringify} https://raw.github.com/douglascrockford/JSON-js/master/json2.js
 *  - jQuery Cookie https://github.com/carhartl/jquery-cookie
 */
var Myna,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__slice=[].slice;Myna=function(a,b){var c;return c=a.jQuery,Myna=function(){function d(a){var b,e=this;a==null&&(a={}),this.initExperiments=__bind(this.initExperiments,this),this.initExperiment=__bind(this.initExperiment,this),this.initGoals=__bind(this.initGoals,this),this.showVariant=__bind(this.showVariant,this),this.eachVariantAndGoal=__bind(this.eachVariantAndGoal,this),this.on=__bind(this.on,this),this.wrapHandler=__bind(this.wrapHandler,this),this.reward=__bind(this.reward,this),this.rewardAjax=__bind(this.rewardAjax,this),this.suggest=__bind(this.suggest,this),this.suggestSkip=__bind(this.suggestSkip,this),this.suggestAjax=__bind(this.suggestAjax,this),this.ajax=__bind(this.ajax,this),this.loadSuggestion=__bind(this.loadSuggestion,this),this.deleteSuggestion=__bind(this.deleteSuggestion,this),this.saveSuggestion=__bind(this.saveSuggestion,this),this.clearSuggestions=__bind(this.clearSuggestions,this),this.saveSuggestions=__bind(this.saveSuggestions,this),this.loadSuggestions=__bind(this.loadSuggestions,this),this.defaultVariant=__bind(this.defaultVariant,this),this.skipSuggestion=__bind(this.skipSuggestion,this),this.exptOption=__bind(this.exptOption,this),this.exptOptions=__bind(this.exptOptions,this),this.error=__bind(this.error,this),this.log=__bind(this.log,this),this.options=c.extend(!0,{},d.defaults,a),this.log("constructor",a),b={cssClass:this.options.cssClass,dataPrefix:this.options.dataPrefix,sticky:this.options.sticky,skipChance:this.options.skipChance,timeout:this.options.timeout},c.each(this.options.experiments,function(a,d){var f,g;return g=d.uuid,f=d["class"],g&&f?(d=c.extend({},b,d),e.options.experiments[g]=d):e.log("no uuid or CSS class",d,g,f,sticky)})}return d.$=c,d.defaults={debug:!1,apiRoot:"//api.mynaweb.com",timeout:1200,cssClass:"myna",dataPrefix:null,sticky:!0,skipChance:0,cookieName:"myna",cookieOptions:{path:"/",expires:7},experiments:[]},d.init=function(a){var e;return a==null&&(a={experiments:[]}),e=new d(a),c(b).ready(function(){return e.initExperiments()}),e},d.prototype.log=function(){var a;a=1<=arguments.length?__slice.call(arguments,0):[];if(this.options.debug)return typeof console!="undefined"&&console!==null?typeof console.log=="function"?console.log.apply(console,a):void 0:void 0},d.prototype.error=function(){var a;throw a=1<=arguments.length?__slice.call(arguments,0):[],this.log.apply(this,a),a},d.prototype.data=function(a,b,c){return a.data(b?""+b+"-"+c:c)},d.prototype.exptOptions=function(a){return this.options.experiments[a]||this.error("no such experiment",a)},d.prototype.exptOption=function(a,b,c){return c==null&&(c=function(){return void 0}),this.exptOptions(a)[b]||c()},d.prototype.skipSuggestion=function(a){return Math.random()<this.exptOption(a,"skipChance")},d.prototype.defaultVariant=function(a){var b,c,d,e;return e=this.exptOptions(a),b=e["default"],b||(c=e["class"],d=e.dataPrefix,this.eachVariantAndGoal(c,d,function(a,c,d){if(a&&!b)return b=a})),b},d.prototype.loadSuggestions=function(){var a,b;this.log("loadSuggestions");try{return a=this.options.cookieName,b=c.cookie.defaults.path,c.cookie.defaults.path=this.options.cookieOptions.path,this.log(" - ",a),JSON.parse(c.cookie(a))||{}}catch(d){return{}}finally{c.cookie.defaults.path=b}},d.prototype.saveSuggestions=function(a){var d,e,f,g,h;this.log("saveSuggestions",a);try{return e=this.options.cookieName,g=JSON.stringify(a),f=this.options.cookieOptions,h=c.cookie.defaults.path,c.cookie.defaults.path=this.options.cookieOptions.path,this.log(" - ",e,g,f),d=c.cookie(e,g,f),this.log(" - ",b.cookie),d}finally{c.cookie.defaults.path=h}},d.prototype.clearSuggestions=function(){var a,b;this.log("clearSuggestions");try{return b=c.cookie.defaults.path,c.cookie.defaults.path=this.options.cookieOptions.path,a=this.options.cookieName,c.removeCookie(a)}finally{c.cookie.defaults.path=b}},d.prototype.saveSuggestion=function(a,b,c,d,e){var f,g;return d==null&&(d=!1),e==null&&(e=!1),this.log("saveSuggestion",a,b,c,d,e),f={uuid:a,choice:b,token:c,skipped:d,rewarded:e},g=this.loadSuggestions(),g[a]=f,this.saveSuggestions(g),f},d.prototype.deleteSuggestion=function(a){var b;this.log("deleteSuggestion",a),b=this.loadSuggestions(),delete b[a],this.saveSuggestions(b)},d.prototype.loadSuggestion=function(a){return this.log("loadSuggestion",a),this.loadSuggestions()[a]||null},d.prototype.ajax=function(b,d,e){var f,g,h,i,j,k,l;this.log("ajax",b,d,e),i=this.options.timeout,l=void 0,h=!1,g=this,k=function(){var b;b=1<=arguments.length?__slice.call(arguments,0):[],g.log.apply(g,[" - ajax success"].concat(__slice.call(b)));if(!h)return a.clearTimeout(f),h=!0,d.apply(null,b)},j=function(a,b,c){g.log(" - ajax error",a,b,c);if(!h)return h=!0,e(a,b,c)};try{return f=a.setTimeout(function(){return j(l,"timeout",i)},i),l=c.ajax({url:b,dataType:"jsonp",crossDomain:!0,success:k,error:j})}catch(m){return j(l,"error",m)}finally{l}},d.prototype.suggestAjax=function(a,b,c){var d,e,f,g=this;return this.log("suggestAjax",a,b,c),d=""+this.options.apiRoot+"/v1/experiment/"+a+"/suggest",f=function(d,e,f){var h;d.typename==="suggestion"?(h=g.saveSuggestion(a,d.choice,d.token,!1,!1),g.log(" - suggest received and stored",h),b(h)):(g.log(" - suggest received "+d.typename,d,e,f),c(f,e,d))},e=function(a,b,d){g.log(" - suggest received error",a,b,d),c(a,b,d)},this.ajax(d,f,e)},d.prototype.suggestSkip=function(a,b,c){var d,e;this.log("suggestSkip",a,b,c),d=this.defaultVariant(a),d?(e=this.saveSuggestion(a,d,null,!0,!1),b(e)):c(null,"no-default-suggestion",a)},d.prototype.suggest=function(a,b,c){var d,e;return b==null&&(b=function(){}),c==null&&(c=function(){}),this.log("suggest",a,b,c),d=this.exptOption(a,"sticky"),e=d&&this.loadSuggestion(a),e?b(e):this.skipSuggestion(a)?this.suggestSkip(a,b,c):this.suggestAjax(a,b,c)},d.prototype.rewardAjax=function(a,b,c,d){var e,f,g,h,i,j,k=this;return this.log("rewardAjax",a,b,c,d),h=a.uuid,f=a.token,e=a.choice,g=""+this.options.apiRoot+"/v1/experiment/"+h+"/reward?token="+f+"&amount="+b,j=function(b,g,i){b.typename==="ok"?(k.log("reward received ok",b,g,i),a=k.saveSuggestion(h,e,f,!1,!0),c(a)):(k.log("reward received "+b.typename,b,g,i),k.deleteSuggestion(h),d(i,g,b))},i=function(a,b,c){k.log("reward received error",a,b,c),k.deleteSuggestion(h),d(a,b,c)},this.ajax(g,j,i)},d.prototype.reward=function(a,b,c,d){var e;b==null&&(b=1),c==null&&(c=function(){}),d==null&&(d=function(){}),e=this.loadSuggestion(a),this.log("reward",a,b,c,d,e),e?e.skipped?(this.log("skipped"),d(void 0,"skipped",a)):e.rewarded?(this.log("repeat reward"),d(void 0,"repeat-reward",a)):this.rewardAjax(e,b,c,d):(this.log("no suggestion"),d(void 0,"no-suggestion",a))},d.prototype.wrapHandler=function(b,d){var e;return e=this,e.log("wrapHandler",b,d),function(){var f,g,h,i,j,k;i=arguments[0],f=2<=arguments.length?__slice.call(arguments,1):[],e.log("wrappedHandler",i),h=this,j=c(h),k=e.loadSuggestion(b);if(k&&!k.rewarded)e.log(" - rewarding and retriggering"),i.stopPropagation(),i.preventDefault(),g=function(){e.log(" - about to retrigger",i,i.type),h[i.type]?(e.log(" - dom method",h,i.type),a.setTimeout(function(){return h[i.type]()},0)):(e.log(" - jQuery trigger",j,i.type),j.trigger(i.type))},e.reward(b,1,g,g);else return e.log(" - retriggering",i,i.type),d.call.apply(d,[this,i].concat(__slice.call(f)))}},d.prototype.on=function(){var a,b,c,d,e,f;e=arguments[0],c=arguments[1],f=arguments[2],a=4<=arguments.length?__slice.call(arguments,3):[],this.log.apply(this,["on",e,c,f].concat(__slice.call(a)));switch(a.length){case 0:return e.on(c,this.wrapHandler(f,function(){}));case 1:return d=a[0],e.on(c,this.wrapHandler(f,d));default:return b=a[0],d=a[1],e.on(c,null,b,this.wrapHandler(f,d))}},d.prototype.eachVariantAndGoal=function(a,b,d){var e=this;return this.log("eachVariantAndGoal",a,b,d),c("."+a).each(function(a,f){var g,h,i,j;return i=c(f),j=e.data(i,b,"show"),g=e.data(i,b,"bind"),h=e.data(i,b,"goal"),d.call(i,j,g,h)})},d.prototype.showVariant=function(a,b,c){return this.log("showVariant",a,b,c),this.eachVariantAndGoal(a,b,function(a,b,d){var e;if(a)switch(a){case c:this.show();break;default:this.hide()}if(b)switch(b){case"text":return this.text(c);case"html":return this.html(c);case"class":return this.addClass(c);default:e=b.match(/@(.*)/);if(e)return this.attr(e[1],c)}})},d.prototype.initGoals=function(a,b,c){var d;return d=this,this.log("initGoals",b,c),this.eachVariantAndGoal(b,c,function(b,c,e){switch(e){case"click":return d.on(this,"click",a);case"load":if(this.is("html,body"))return d.reward(a,1)}})},d.prototype.initExperiment=function(a){var b,c,d,e,f,g,h=this;g=a.uuid,b=a["class"],c=a.dataPrefix,e=this.loadSuggestion(g),this.log("initExperiment",g,b,c,e),f=function(a){h.log(" - initExperiment success",a),h.showVariant(b,c,a.choice),!a.skipped&&!a.rewarded&&a.token&&h.initGoals(g,b,c)},d=function(){var a;h.log(" - initExperiment error"),a=h.defaultVariant(g),a&&h.showVariant(b,c,a)},this.suggest(g,f,d)},d.prototype.initExperiments=function(){var a=this;c.each(this.options.experiments,function(b,c){return a.initExperiment(c)})},d}()}(window,document);