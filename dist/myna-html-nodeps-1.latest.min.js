/*!
 * Myna for HTML v1.1.2 (no dependencies)
 * Copyright 2012 Myna Ltd
 * License: BSD 3-clause (http://opensource.org/licenses/BSD-3-Clause)
 * Published: 2013-01-02
 * Dependencies:
 *  - jQuery 1.5+ http://jquery.com/download
 *  - JSON.{parse,stringify} https://raw.github.com/douglascrockford/JSON-js/master/json2.js
 *  - jQuery Cookie https://github.com/carhartl/jquery-cookie
 */
var Myna,__bind=function(e,t){return function(){return e.apply(t,arguments)}},__slice=[].slice;Myna=function(e,t){var n;return n=e.jQuery,Myna=function(){function r(e){var t,i=this;e==null&&(e={}),this.initExperiments=__bind(this.initExperiments,this),this.initExperiment=__bind(this.initExperiment,this),this.initGoals=__bind(this.initGoals,this),this.showVariant=__bind(this.showVariant,this),this.eachVariantAndGoal=__bind(this.eachVariantAndGoal,this),this.on=__bind(this.on,this),this.wrapHandler=__bind(this.wrapHandler,this),this.reward=__bind(this.reward,this),this.rewardAjax=__bind(this.rewardAjax,this),this.suggest=__bind(this.suggest,this),this.suggestSkip=__bind(this.suggestSkip,this),this.suggestAjax=__bind(this.suggestAjax,this),this.ajax=__bind(this.ajax,this),this.loadSuggestion=__bind(this.loadSuggestion,this),this.deleteSuggestion=__bind(this.deleteSuggestion,this),this.saveSuggestion=__bind(this.saveSuggestion,this),this.clearSuggestions=__bind(this.clearSuggestions,this),this.saveSuggestions=__bind(this.saveSuggestions,this),this.loadSuggestions=__bind(this.loadSuggestions,this),this.defaultVariant=__bind(this.defaultVariant,this),this.skipSuggestion=__bind(this.skipSuggestion,this),this.exptOption=__bind(this.exptOption,this),this.exptOptions=__bind(this.exptOptions,this),this.error=__bind(this.error,this),this.log=__bind(this.log,this),this.options=n.extend(!0,{},r.defaults,e),this.log("constructor",e),t={cssClass:this.options.cssClass,dataPrefix:this.options.dataPrefix,sticky:this.options.sticky,skipChance:this.options.skipChance,timeout:this.options.timeout},n.each(this.options.experiments,function(e,r){var s,o;return o=r.uuid,s=r["class"],o&&s?(r=n.extend({},t,r),i.options.experiments[o]=r):i.log("no uuid or CSS class",r,o,s,sticky)})}return r.$=n,r.defaults={debug:!1,apiRoot:"//api.mynaweb.com",timeout:1200,cssClass:"myna",dataPrefix:null,sticky:!0,skipChance:0,cookieName:"myna",cookieOptions:{path:"/",expires:7},experiments:[]},r.init=function(e){var i;return e==null&&(e={experiments:[]}),i=new r(e),n(t).ready(function(){return i.initExperiments()}),i},r.prototype.log=function(){var e;e=1<=arguments.length?__slice.call(arguments,0):[];if(this.options.debug)return typeof console!="undefined"&&console!==null?typeof console.log=="function"?console.log.apply(console,e):void 0:void 0},r.prototype.error=function(){var e;throw e=1<=arguments.length?__slice.call(arguments,0):[],this.log.apply(this,e),e},r.prototype.data=function(e,t,n){return e.data(t?""+t+"-"+n:n)},r.prototype.exptOptions=function(e){return this.options.experiments[e]||this.error("no such experiment",e)},r.prototype.exptOption=function(e,t,n){return n==null&&(n=function(){return void 0}),this.exptOptions(e)[t]||n()},r.prototype.skipSuggestion=function(e){return Math.random()<this.exptOption(e,"skipChance")},r.prototype.defaultVariant=function(e){var t,n,r,i;return i=this.exptOptions(e),t=i["default"],t||(n=i["class"],r=i.dataPrefix,this.eachVariantAndGoal(n,r,function(e,n,r){if(e&&!t)return t=e})),t},r.prototype.loadSuggestions=function(){var e,t;this.log("loadSuggestions");try{return e=this.options.cookieName,t=n.cookie.defaults.path,n.cookie.defaults.path=this.options.cookieOptions.path,this.log(" - ",e),JSON.parse(n.cookie(e))||{}}catch(r){return{}}finally{n.cookie.defaults.path=t}},r.prototype.saveSuggestions=function(e){var r,i,s,o,u;this.log("saveSuggestions",e);try{return i=this.options.cookieName,o=JSON.stringify(e),s=this.options.cookieOptions,u=n.cookie.defaults.path,n.cookie.defaults.path=this.options.cookieOptions.path,this.log(" - ",i,o,s),r=n.cookie(i,o,s),this.log(" - ",t.cookie),r}finally{n.cookie.defaults.path=u}},r.prototype.clearSuggestions=function(){var e,t;this.log("clearSuggestions");try{return t=n.cookie.defaults.path,n.cookie.defaults.path=this.options.cookieOptions.path,e=this.options.cookieName,n.removeCookie(e)}finally{n.cookie.defaults.path=t}},r.prototype.saveSuggestion=function(e,t,n,r,i){var s,o;return r==null&&(r=!1),i==null&&(i=!1),this.log("saveSuggestion",e,t,n,r,i),s={uuid:e,choice:t,token:n,skipped:r,rewarded:i},o=this.loadSuggestions(),o[e]=s,this.saveSuggestions(o),s},r.prototype.deleteSuggestion=function(e){var t;this.log("deleteSuggestion",e),t=this.loadSuggestions(),delete t[e],this.saveSuggestions(t)},r.prototype.loadSuggestion=function(e){return this.log("loadSuggestion",e),this.loadSuggestions()[e]||null},r.prototype.ajax=function(t,r,i){var s,o,u,a,f,l,c;this.log("ajax",t,r,i),a=this.options.timeout,c=void 0,u=!1,o=this,l=function(){var t;t=1<=arguments.length?__slice.call(arguments,0):[],o.log.apply(o,[" - ajax success"].concat(__slice.call(t)));if(!u)return e.clearTimeout(s),u=!0,r.apply(null,t)},f=function(e,t,n){o.log(" - ajax error",e,t,n);if(!u)return u=!0,i(e,t,n)};try{return s=e.setTimeout(function(){return f(c,"timeout",a)},a),c=n.ajax({url:t,dataType:"jsonp",crossDomain:!0,success:l,error:f})}catch(h){return f(c,"error",h)}finally{c}},r.prototype.suggestAjax=function(e,t,n){var r,i,s,o=this;return this.log("suggestAjax",e,t,n),r=""+this.options.apiRoot+"/v1/experiment/"+e+"/suggest",s=function(r,i,s){var u;r.typename==="suggestion"?(u=o.saveSuggestion(e,r.choice,r.token,!1,!1),o.log(" - suggest received and stored",u),t(u)):(o.log(" - suggest received "+r.typename,r,i,s),n(s,i,r))},i=function(e,t,r){o.log(" - suggest received error",e,t,r),n(e,t,r)},this.ajax(r,s,i)},r.prototype.suggestSkip=function(e,t,n){var r,i;this.log("suggestSkip",e,t,n),r=this.defaultVariant(e),r?(i=this.saveSuggestion(e,r,null,!0,!1),t(i)):n(null,"no-default-suggestion",e)},r.prototype.suggest=function(e,t,n){var r,i;return t==null&&(t=function(){}),n==null&&(n=function(){}),this.log("suggest",e,t,n),r=this.exptOption(e,"sticky"),i=r&&this.loadSuggestion(e),i?t(i):this.skipSuggestion(e)?this.suggestSkip(e,t,n):this.suggestAjax(e,t,n)},r.prototype.rewardAjax=function(e,t,n,r){var i,s,o,u,a,f,l=this;return this.log("rewardAjax",e,t,n,r),u=e.uuid,s=e.token,i=e.choice,o=""+this.options.apiRoot+"/v1/experiment/"+u+"/reward?token="+s+"&amount="+t,f=function(t,r,o){t.typename==="ok"?(l.log("reward received ok",t,r,o),e=l.saveSuggestion(u,i,s,!1,!0),n(e)):l.log("reward received "+t.typename,t,r,o)},a=function(e,t,n){l.log("reward received error",e,t,n),l.deleteSuggestion(u),r(e,t,n)},this.ajax(o,f,a)},r.prototype.reward=function(e,t,n,r){var i;t==null&&(t=1),n==null&&(n=function(){}),r==null&&(r=function(){}),i=this.loadSuggestion(e),this.log("reward",e,t,n,r,i),i?i.skipped?(this.log("skipped"),r(void 0,"skipped",e)):i.rewarded?(this.log("repeat reward"),r(void 0,"repeat-reward",e)):this.rewardAjax(i,t,n,r):(this.log("no suggestion"),r(void 0,"no-suggestion",e))},r.prototype.wrapHandler=function(t,r){var i;return i=this,i.log("wrapHandler",t,r),function(){var s,o,u,a,f,l;a=arguments[0],s=2<=arguments.length?__slice.call(arguments,1):[],i.log("wrappedHandler",a),u=this,f=n(u),l=i.loadSuggestion(t);if(!l||!!l.rewarded)return i.log(" - retriggering",a,a.type),r.call.apply(r,[this,a].concat(__slice.call(s)));i.log(" - rewarding and retriggering"),a.stopPropagation(),a.preventDefault(),o=function(){i.log(" - about to retrigger",a,a.type),u[a.type]?(i.log(" - dom method",u,a.type),e.setTimeout(function(){return u[a.type]()},0)):(i.log(" - jQuery trigger",f,a.type),f.trigger(a.type))},i.reward(t,1,o,o)}},r.prototype.on=function(){var e,t,n,r,i,s;i=arguments[0],n=arguments[1],s=arguments[2],e=4<=arguments.length?__slice.call(arguments,3):[],this.log.apply(this,["on",i,n,s].concat(__slice.call(e)));switch(e.length){case 0:return i.on(n,this.wrapHandler(s,function(){}));case 1:return r=e[0],i.on(n,this.wrapHandler(s,r));default:return t=e[0],r=e[1],i.on(n,null,t,this.wrapHandler(s,r))}},r.prototype.eachVariantAndGoal=function(e,t,r){var i=this;return this.log("eachVariantAndGoal",e,t,r),n("."+e).each(function(e,s){var o,u,a,f;return a=n(s),f=i.data(a,t,"show"),o=i.data(a,t,"bind"),u=i.data(a,t,"goal"),r.call(a,f,o,u)})},r.prototype.showVariant=function(e,t,n){return this.log("showVariant",e,t,n),this.eachVariantAndGoal(e,t,function(e,t,r){var i;if(e)switch(e){case n:this.show();break;default:this.hide()}if(t)switch(t){case"text":return this.text(n);case"html":return this.html(n);case"class":return this.addClass(n);default:i=t.match(/@(.*)/);if(i)return this.attr(i[1],n)}})},r.prototype.initGoals=function(e,t,n){var r;return r=this,this.log("initGoals",t,n),this.eachVariantAndGoal(t,n,function(t,n,i){switch(i){case"click":return r.on(this,"click",e);case"load":if(this.is("html,body"))return r.reward(e,1)}})},r.prototype.initExperiment=function(e){var t,n,r,i,s,o,u=this;o=e.uuid,t=e["class"],n=e.dataPrefix,i=this.loadSuggestion(o),this.log("initExperiment",o,t,n,i),s=function(e){u.log(" - initExperiment success",e),u.showVariant(t,n,e.choice),!e.skipped&&!e.rewarded&&e.token&&u.initGoals(o,t,n)},r=function(){var e;u.log(" - initExperiment error"),e=u.defaultVariant(o),e&&u.showVariant(t,n,e)},this.suggest(o,s,r)},r.prototype.initExperiments=function(){var e=this;n.each(this.options.experiments,function(t,n){return e.initExperiment(n)})},r}()}(window,document);