var Myna,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__slice=[].slice;Myna=function(a,b,c){return Myna=function(){function d(a){var b,e,f,g,h,i,j=this;null==a&&(a={}),this.initExperiments=__bind(this.initExperiments,this),this.initExperiment=__bind(this.initExperiment,this),this.initGoals=__bind(this.initGoals,this),this.showVariant=__bind(this.showVariant,this),this.eachVariantAndGoal=__bind(this.eachVariantAndGoal,this),this.on=__bind(this.on,this),this.wrapHandler=__bind(this.wrapHandler,this),this.reward=__bind(this.reward,this),this.rewardAjax=__bind(this.rewardAjax,this),this.suggest=__bind(this.suggest,this),this.suggestSkip=__bind(this.suggestSkip,this),this.suggestAjax=__bind(this.suggestAjax,this),this.trackGoogleRewardEvent=__bind(this.trackGoogleRewardEvent,this),this.trackGoogleSuggestEvent=__bind(this.trackGoogleSuggestEvent,this),this.ajax=__bind(this.ajax,this),this.loadSuggestion=__bind(this.loadSuggestion,this),this.deleteSuggestion=__bind(this.deleteSuggestion,this),this.saveSuggestion=__bind(this.saveSuggestion,this),this.clearSuggestions=__bind(this.clearSuggestions,this),this.saveSuggestions=__bind(this.saveSuggestions,this),this.loadSuggestions=__bind(this.loadSuggestions,this),this.defaultVariant=__bind(this.defaultVariant,this),this.target=__bind(this.target,this),this.exptCallback=__bind(this.exptCallback,this),this.exptGoogleOption=__bind(this.exptGoogleOption,this),this.exptOption=__bind(this.exptOption,this),this.exptOptions=__bind(this.exptOptions,this),this.data=__bind(this.data,this),this.error=__bind(this.error,this),this.log=__bind(this.log,this),this.options=c.extend(!0,{},d.defaults,a),this.log("constructor",a),b={cssClass:this.options.cssClass,dataPrefix:this.options.dataPrefix,sticky:this.options.sticky,callbacks:{beforeSave:null!=(f=this.options.callbacks)?f.beforeSave:void 0,beforeSuggest:null!=(g=this.options.callbacks)?g.beforeSuggest:void 0,target:(null!=(h=this.options.callbacks)?h.target:void 0)?null!=(i=this.options.callbacks)?i.target:void 0:this.options.skipChance?function(){return Math.random()<j.options.skipChance}:function(){return!0}},timeout:this.options.timeout},e={},c.each(this.options.experiments,function(a,d){var f,g,h,i,k;return i=d.uuid,f=d["class"],h=d.sticky,d.skipChance&&((null!=(k=d.callbacks)?k.target:void 0)||(d.callbacks=c.extend(!0,{},d.callbacks||{},{target:function(){return Math.random()<d.skipChance}}))),g={googleAnalytics:{enabled:j.options.googleAnalytics.enabled,viewEvent:d.uuid?""+d.uuid+"-view":null,conversionEvent:d.uuid?""+d.uuid+"-conversion":null}},i&&f?e[i]=c.extend(!0,{},b,g,d):j.log("no uuid or CSS class",d,i,f,h)}),this.options.experiments=e}return d.$=c,d.defaults={debug:!1,apiRoot:"//api.mynaweb.com",timeout:1200,cssClass:"myna",dataPrefix:null,sticky:!0,cookieName:"myna",cookieOptions:{path:"/",expires:7},experiments:[],skipChance:0,googleAnalytics:{enabled:!0},callbacks:{beforeSave:function(a){return a},beforeSuggest:function(){},target:null}},d.init=function(a){var e;return null==a&&(a={experiments:[]}),e=new d(a),c(b).ready(function(){return e.initExperiments()}),e},d.prototype.log=function(){var a;return a=1<=arguments.length?__slice.call(arguments,0):[],this.options.debug?"undefined"!=typeof console&&null!==console?"function"==typeof console.log?console.log.apply(console,a):void 0:void 0:void 0},d.prototype.error=function(){var a;throw a=1<=arguments.length?__slice.call(arguments,0):[],this.log.apply(this,a),a},d.prototype.data=function(a,b,c){return a.data(b?""+b+"-"+c:c)},d.prototype.exptOptions=function(a){return this.options.experiments[a]||this.error("no such experiment",a)},d.prototype.exptOption=function(a,b,c){var d;return null==c&&(c=function(){return void 0}),d=this.exptOptions(a)[b],null!=d?d:c()},d.prototype.exptGoogleOption=function(a,b,c){var d,e;return null==c&&(c=function(){return void 0}),d=null!=(e=this.exptOptions(a).googleAnalytics)?e[b]:void 0,null!=d?d:c()},d.prototype.exptCallback=function(a,b,c){var d,e;return null==c&&(c=function(){return void 0}),d=null!=(e=this.exptOptions(a).callbacks)?e[b]:void 0,null!=d?d:c()},d.prototype.target=function(a){var b;return b=this.exptCallback(a,"target",function(){return function(){return 1}}),b()},d.prototype.defaultVariant=function(a){var b,c,d,e;return e=this.exptOptions(a),b=e["default"],b||(c=e["class"],d=e.dataPrefix,this.eachVariantAndGoal(c,d,function(a){return a&&!b?b=a:void 0})),b},d.prototype.loadSuggestions=function(){var a,b,d;this.log("loadSuggestions");try{return a=this.options.cookieName,d=c.cookie.defaults.path,c.cookie.defaults.path=this.options.cookieOptions.path,this.log(" - ",a),JSON.parse(c.cookie(a))||{}}catch(e){return b=e,{}}finally{c.cookie.defaults.path=d}},d.prototype.saveSuggestions=function(a){var d,e,f,g,h;this.log("saveSuggestions",a);try{return e=this.options.cookieName,g=JSON.stringify(a),f=this.options.cookieOptions,h=c.cookie.defaults.path,c.cookie.defaults.path=this.options.cookieOptions.path,this.log(" - ",e,g,f),d=c.cookie(e,g,f),this.log(" - ",b.cookie),d}finally{c.cookie.defaults.path=h}},d.prototype.clearSuggestions=function(){var a,b;this.log("clearSuggestions");try{return b=c.cookie.defaults.path,c.cookie.defaults.path=this.options.cookieOptions.path,a=this.options.cookieName,c.removeCookie(a)}finally{c.cookie.defaults.path=b}},d.prototype.saveSuggestion=function(a,b,c,d,e){var f,g,h,i,j;return null==d&&(d=!1),null==e&&(e=!1),this.log("saveSuggestion",a,b,c,d,e),f=this.exptCallback(a,"beforeSave",function(){return function(a){return a}}),j={uuid:a,choice:b,token:c,skipped:d,rewarded:e},g=f(j),h="object"==typeof g?g:j,this.log(" - uncustomised",j),this.log(" - customised",g),this.log(" - stored",h),i=this.loadSuggestions(),i[a]=h,this.saveSuggestions(i),h},d.prototype.deleteSuggestion=function(a){var b;this.log("deleteSuggestion",a),b=this.loadSuggestions(),delete b[a],this.saveSuggestions(b)},d.prototype.loadSuggestion=function(a){return this.log("loadSuggestion",a),this.loadSuggestions()[a]||null},d.prototype.ajax=function(b,d,e){var f,g,h,i,j,k,l,m;this.log("ajax",b,d,e),j=this.options.timeout,m=void 0,i=!1,h=this,l=function(){var b;return b=1<=arguments.length?__slice.call(arguments,0):[],h.log.apply(h,[" - ajax success"].concat(__slice.call(b))),i?void 0:(a.clearTimeout(f),i=!0,d.apply(null,b))},k=function(a,b,c){return h.log(" - ajax error",a,b,c),i?void 0:(i=!0,e(a,b,c))};try{return f=a.setTimeout(function(){return k(m,"timeout",j)},j),m=c.ajax({url:b,dataType:"jsonp",crossDomain:!0,success:l,error:k})}catch(n){return g=n,k(m,"error",g)}finally{}},d.prototype.trackGoogleSuggestEvent=function(a,b){var c,d;return c=this.exptGoogleOption(a,"enabled",function(){return!0}),d=this.exptGoogleOption(a,"viewEvent",function(){return""+a+"-view"}),c?"undefined"!=typeof _gaq&&null!==_gaq?_gaq.push(["_trackEvent","myna",d,b]):void 0:void 0},d.prototype.trackGoogleRewardEvent=function(a,b){var c,d;return c=this.exptGoogleOption(a,"enabled",function(){return!0}),d=this.exptGoogleOption(a,"conversionEvent",function(){return""+a+"-conversion"}),c?"undefined"!=typeof _gaq&&null!==_gaq?_gaq.push(["_trackEvent","myna",d,b]):void 0:void 0},d.prototype.suggestAjax=function(a,b,c){var d,e,f,g=this;return this.log("suggestAjax",a,b,c),d=""+this.options.apiRoot+"/v1/experiment/"+a+"/suggest",f=function(d,e,f){var h;"suggestion"===d.typename?(h=g.saveSuggestion(a,d.choice,d.token,!1,!1),g.log(" - suggest received and stored",h),g.trackGoogleSuggestEvent(a,d.choice),b(h)):(g.log(" - suggest received "+d.typename,d,e,f),c(f,e,d))},e=function(a,b,d){g.log(" - suggest received error",a,b,d),c(a,b,d)},this.ajax(d,f,e)},d.prototype.suggestSkip=function(a,b,c){var d,e;this.log("suggestSkip",a,b,c),d=this.defaultVariant(a),d?(e=this.saveSuggestion(a,d,null,!0,!1),b(e)):c(null,"no-default-suggestion",a)},d.prototype.suggest=function(a,b,c){var d,e,f,g;return null==b&&(b=function(){}),null==c&&(c=function(){}),this.log("suggest",a,b,c),e=this.exptOption(a,"sticky"),f=e&&this.loadSuggestion(a),d=this.exptCallback(a,"beforeSuggest",function(){return function(){}}),g=function(a){return d(a,!0),b(a)},f?(d(f,!1),b(f)):this.target(a)?this.suggestAjax(a,g,c):this.suggestSkip(a,g,c)},d.prototype.rewardAjax=function(a,b,c,d){var e,f,g,h,i,j,k=this;return this.log("rewardAjax",a,b,c,d),h=a.uuid,f=a.token,e=a.choice,g=""+this.options.apiRoot+"/v1/experiment/"+h+"/reward?token="+f+"&amount="+b,j=function(b,g,i){"ok"===b.typename?(k.log("reward received ok",b,g,i),a=k.saveSuggestion(h,e,f,!1,!0),c(a)):(k.log("reward received "+b.typename,b,g,i),k.deleteSuggestion(h),d(i,g,b))},i=function(a,b,c){k.log("reward received error",a,b,c),k.deleteSuggestion(h),d(a,b,c)},this.trackGoogleRewardEvent(h,e),this.ajax(g,j,i)},d.prototype.reward=function(a,b,c,d){var e;null==b&&(b=1),null==c&&(c=function(){}),null==d&&(d=function(){}),e=this.loadSuggestion(a),this.log("reward",a,b,c,d,e),e?e.skipped?(this.log("skipped"),d(void 0,"skipped",a)):e.rewarded?(this.log("repeat reward"),d(void 0,"repeat-reward",a)):this.rewardAjax(e,b,c,d):(this.log("no suggestion"),d(void 0,"no-suggestion",a))},d.prototype.wrapHandler=function(b,d){var e;return e=this,e.log("wrapHandler",b,d),function(){var f,g,h,i,j,k;return i=arguments[0],f=2<=arguments.length?__slice.call(arguments,1):[],e.log("wrappedHandler",i),h=this,j=c(h),k=e.loadSuggestion(b),!k||k.rewarded?(e.log(" - retriggering",i,i.type),d.call.apply(d,[this,i].concat(__slice.call(f)))):(e.log(" - rewarding and retriggering"),i.stopPropagation(),i.preventDefault(),g=function(){e.log(" - about to retrigger",i,i.type),h[i.type]?(e.log(" - dom method",h,i.type),a.setTimeout(function(){return h[i.type]()},0)):(e.log(" - jQuery trigger",j,i.type),j.trigger(i.type))},e.reward(b,1,g,g),void 0)}},d.prototype.on=function(){var a,b,c,d,e,f;switch(e=arguments[0],c=arguments[1],f=arguments[2],a=4<=arguments.length?__slice.call(arguments,3):[],this.log.apply(this,["on",e,c,f].concat(__slice.call(a))),a.length){case 0:return e.on(c,this.wrapHandler(f,function(){}));case 1:return d=a[0],e.on(c,this.wrapHandler(f,d));default:return b=a[0],d=a[1],e.on(c,null,b,this.wrapHandler(f,d))}},d.prototype.eachVariantAndGoal=function(a,b,d){var e=this;return this.log("eachVariantAndGoal",a,b,d),c("."+a).each(function(a,f){var g,h,i,j;return i=c(f),j=e.data(i,b,"show"),g=e.data(i,b,"bind"),h=e.data(i,b,"goal"),d.call(i,j,g,h)})},d.prototype.showVariant=function(a,b,c){return this.log("showVariant",a,b,c),this.eachVariantAndGoal(a,b,function(a,b){var d;if(a)switch(a){case c:this.show();break;default:this.hide()}if(b)switch(b){case"text":return this.text(c);case"html":return this.html(c);case"class":return this.addClass(c);default:if(d=b.match(/@(.*)/))return this.attr(d[1],c)}})},d.prototype.initGoals=function(a,b,c){var d;return d=this,this.log("initGoals",b,c),this.eachVariantAndGoal(b,c,function(b,c,e){switch(d.log("initGoals visiting",this,b,c,e),e){case"click":return d.on(this,"click",a);case"load":if(this.is("html,body"))return d.reward(a,1)}})},d.prototype.initExperiment=function(a){var b,c,d,e,f,g,h=this;g=a.uuid,b=a["class"],c=a.dataPrefix,e=this.loadSuggestion(g),this.log("initExperiment",g,b,c,e),f=function(a){h.log(" - initExperiment success",a),h.showVariant(b,c,a.choice),a.skipped||a.rewarded||!a.token||h.initGoals(g,b,c)},d=function(){var a;h.log(" - initExperiment error"),a=h.defaultVariant(g),a&&h.showVariant(b,c,a)},this.suggest(g,f,d)},d.prototype.initExperiments=function(){var a=this;c.each(this.options.experiments,function(b,c){return a.initExperiment(c)})},d}()}(window,document,jQuery);